<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Talk Buddy Setup</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background-color: #f8fbfc;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }

    h1 {
      color: #007c91;
      margin-bottom: 20px;
    }

    button {
      background-color: #00bcd4;
      color: white;
      border: none;
      padding: 14px 24px;
      margin: 8px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background-color: #0097a7;
    }

    button.selected {
      background-color: #ff6f61;
    }

    .hidden {
      display: none;
    }

    .category {
      margin-bottom: 20px;
    }

    .category-title {
      font-weight: 600;
      color: #007c91;
      margin-bottom: 10px;
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .options button {
      flex: 1 1 40%;
      margin: 6px;
      min-width: 100px;
    }

    #letsTalk {
      background-color: #ff6f61;
      font-weight: bold;
      margin-top: 20px;
      opacity: 0.6;
      pointer-events: none;
    }

    #letsTalk.active {
      opacity: 1;
      pointer-events: auto;
    }

    #sessionControls button {
      background-color: #00bcd4;
      margin: 10px;
      opacity: 0.6;
      pointer-events: none;
    }

    #sessionControls button.active {
      opacity: 1;
      pointer-events: auto;
    }

    .slide {
      transform: translateX(100%);
      transition: transform 0.5s ease;
    }

    .slide.active {
      transform: translateX(0);
    }

    @media (max-width: 600px) {
      button {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Talk Buddy</h1>

    <!-- Start Session Screen -->
    <div id="startScreen" class="screen active">
      <button id="startSessionBtn" onclick="startSession()">Start Session</button>
    </div>

    <!-- Setup Screen -->
    <div id="setupScreen" class="screen slide hidden">
      <div id="setupForm">
        <div class="category" data-category="gender">
          <div class="category-title">Gender</div>
          <div class="options">
            <button>man</button>
            <button>woman</button>
          </div>
        </div>

        <div class="category" data-category="age_group">
          <div class="category-title">Age Group</div>
          <div class="options">
            <button>kid</button>
            <button>teen</button>
            <button>adult</button>
          </div>
        </div>

        <div class="category" data-category="level">
          <div class="category-title">Level</div>
          <div class="options">
            <button>A1</button>
            <button>A2</button>
            <button>B1</button>
            <button>B2</button>
            <button>C1</button>
            <button>C2</button>
          </div>
        </div>

        <div class="category" data-category="voice">
          <div class="category-title">Talk Buddy's name</div>
          <div class="options">
            <button data-voice="male">Johnny (male)</button>
            <button data-voice="female">Jill (female)</button>
          </div>
        </div>

        <div class="category" data-category="topic">
          <div class="category-title">Topic</div>
          <div class="options">
            <button>cafe</button><button>travel</button><button>hotel</button>
            <button>phone</button><button>health</button><button>hobbies</button>
            <button>films</button><button>shopping</button><button>directions</button>
            <button>weather</button><button>interview</button><button>school</button>
            <button>dating</button><button>friends</button><button>presentation</button>
            <button>sports</button><button>gossip</button><button>finance</button>
            <button>music</button><button>tech</button>
          </div>
        </div>

        <div class="category" data-category="mode">
          <div class="category-title">Mode</div>
          <div class="options">
            <button>Roleplay</button>
            <button>Question and Answer</button>
            <button>Shadowing</button>
            <button>Free Conversation</button>
          </div>
        </div>

        <button id="letsTalk" onclick="beginChat()">Let‚Äôs talk!</button>
      </div>
    </div>

    <!-- Chat Control Buttons -->
    <div id="sessionControls" class="hidden">
      <button id="changeTopic" onclick="changeTopic()">Change Topic</button>
      <button id="changeMode" onclick="changeMode()">Change Mode</button>
      <button id="endSession" onclick="endSession()">End Session</button>
    </div>
  </div>

<script>
/* --- CONFIG --- */
const PROXY_URL = "https://talk-buddy-proxy.vercel.app/api/talk-buddy";

/* --- GLOBAL STATE --- */
let selections = {
  gender: null,
  age_group: null,
  level: null,
  buddyName: null,
  topic: null,
  mode: null
};

/* --- BUTTON LOGIC --- */
// Called by each setup button (e.g., onclick="selectOption('gender','female')")
function selectOption(category, value) {
  selections[category] = value;

  // Highlight selected button visually
  const buttons = document.querySelectorAll(`.btn-${category}`);
  buttons.forEach(btn => btn.classList.remove("active"));
  const targetBtn = document.getElementById(`${category}-${value}`);
  if (targetBtn) targetBtn.classList.add("active");

  // Check if setup is complete
  checkCompletion();
}

/* --- CHECK COMPLETION --- */
function checkCompletion() {
  const allChosen = Object.values(selections).every(v => v !== null);
  const talkButton = document.getElementById("letsTalkBtn");

  if (talkButton) {
    talkButton.disabled = !allChosen;
    talkButton.style.opacity = allChosen ? "1" : "0.6";
  }
}

/* --- START SESSION --- */
document.addEventListener("DOMContentLoaded", () => {
  const talkButton = document.getElementById("letsTalkBtn");

  if (!talkButton) {
    console.error("‚ùå Button #letsTalkBtn not found in HTML.");
    return;
  }

  talkButton.addEventListener("click", () => {
    console.log("‚úÖ Let's Talk button clicked. Sending startSession message...");

    // 1Ô∏è‚É£ Notify Talk Buddy GPT (when loaded inside GPT webview)
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ action: "startSession", selections }, "*");
        console.log("üì® startSession message sent to Talk Buddy:", selections);
      } else {
        console.log("‚ö†Ô∏è Not inside Talk Buddy ‚Äî running standalone mode.");
      }
    } catch (err) {
      console.error("üö® postMessage error:", err);
    }

    // 2Ô∏è‚É£ Start your chat fetch call through the secure proxy
    startChat();
  });
});

/* --- FETCH CALL TO PROXY --- */
async function startChat() {
  try {
    appendMessage("system", "‚è≥ Buddy is getting ready...");

    const response = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [
          { role: "system", content: "You are Talk Buddy, the English tutor." },
          { role: "user", content: `Start session with ${JSON.stringify(selections)}` }
        ]
      })
    });

    const data = await response.json();

    if (data.error) {
      appendMessage("system", `‚ö†Ô∏è Proxy Error: ${data.error}`);
      console.error("Proxy error:", data);
      return;
    }

    const reply = data.choices?.[0]?.message?.content || "(No reply)";
    appendMessage("buddy", reply);
  } catch (err) {
    appendMessage("system", "‚ö†Ô∏è Network error: " + err.message);
    console.error("Network error:", err);
  }
}

/* --- SIMPLE CHAT DISPLAY --- */
function appendMessage(role, text) {
  const chat = document.getElementById("chat");
  if (!chat) return;
  const p = document.createElement("p");
  p.className = role;
  p.innerText = `${role === "buddy" ? "Buddy:" : ""} ${text}`;
  chat.appendChild(p);
  chat.scrollTop = chat.scrollHeight;
}
</script>
</body>
</html>




