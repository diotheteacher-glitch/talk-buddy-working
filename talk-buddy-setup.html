<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Talk Buddy Setup</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background-color: #f8fbfc;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }

    h1 {
      color: #007c91;
      margin-bottom: 20px;
    }

    button {
      background-color: #00bcd4;
      color: white;
      border: none;
      padding: 14px 24px;
      margin: 8px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background-color: #0097a7;
    }

    button.selected {
      background-color: #ff6f61;
    }

    .hidden {
      display: none;
    }

    .category {
      margin-bottom: 20px;
    }

    .category-title {
      font-weight: 600;
      color: #007c91;
      margin-bottom: 10px;
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .options button {
      flex: 1 1 40%;
      margin: 6px;
      min-width: 100px;
    }

    #letsTalk {
      background-color: #ff6f61;
      font-weight: bold;
      margin-top: 20px;
      opacity: 0.6;
      pointer-events: none;
    }

    #letsTalk.active {
      opacity: 1;
      pointer-events: auto;
    }

    #sessionControls button {
      background-color: #00bcd4;
      margin: 10px;
      opacity: 0.6;
      pointer-events: none;
    }

    #sessionControls button.active {
      opacity: 1;
      pointer-events: auto;
    }

    .slide {
      transform: translateX(100%);
      transition: transform 0.5s ease;
    }

    .slide.active {
      transform: translateX(0);
    }

    @media (max-width: 600px) {
      button {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Talk Buddy</h1>

    <!-- Start Session Screen -->
    <div id="startScreen" class="screen active">
      <button id="startSessionBtn" onclick="startSession()">Start Session</button>
    </div>

    <!-- Setup Screen -->
    <div id="setupScreen" class="screen slide hidden">
      <div id="setupForm">
        <div class="category" data-category="gender">
          <div class="category-title">Gender</div>
          <div class="options">
            <button>man</button>
            <button>woman</button>
          </div>
        </div>

        <div class="category" data-category="age_group">
          <div class="category-title">Age Group</div>
          <div class="options">
            <button>kid</button>
            <button>teen</button>
            <button>adult</button>
          </div>
        </div>

        <div class="category" data-category="level">
          <div class="category-title">Level</div>
          <div class="options">
            <button>A1</button>
            <button>A2</button>
            <button>B1</button>
            <button>B2</button>
            <button>C1</button>
            <button>C2</button>
          </div>
        </div>

        <div class="category" data-category="voice">
          <div class="category-title">Talk Buddy's name</div>
          <div class="options">
            <button data-voice="male">Johnny (male)</button>
            <button data-voice="female">Jill (female)</button>
          </div>
        </div>

        <div class="category" data-category="topic">
          <div class="category-title">Topic</div>
          <div class="options">
            <button>cafe</button><button>travel</button><button>hotel</button>
            <button>phone</button><button>health</button><button>hobbies</button>
            <button>films</button><button>shopping</button><button>directions</button>
            <button>weather</button><button>interview</button><button>school</button>
            <button>dating</button><button>friends</button><button>presentation</button>
            <button>sports</button><button>gossip</button><button>finance</button>
            <button>music</button><button>tech</button>
          </div>
        </div>

        <div class="category" data-category="mode">
          <div class="category-title">Mode</div>
          <div class="options">
            <button>Roleplay</button>
            <button>Question and Answer</button>
            <button>Shadowing</button>
            <button>Free Conversation</button>
          </div>
        </div>

        <button id="letsTalk" onclick="beginChat()">Letâ€™s talk!</button>
      </div>
    </div>

    <!-- Chat Control Buttons -->
    <div id="sessionControls" class="hidden">
      <button id="changeTopic" onclick="changeTopic()">Change Topic</button>
      <button id="changeMode" onclick="changeMode()">Change Mode</button>
      <button id="endSession" onclick="endSession()">End Session</button>
    </div>
  </div>

  <script>
    const PROXY_URL = "https://talkbuddy-proxy.vercel.app/api/talkbuddy";
    const selections = {};
    const requiredCategories = [
      'gender', 'age_group', 'level', 'voice', 'topic', 'mode'
      // Collect all the selections from your setup buttons
const selections = {
  gender: selectedGender,       // Example variable from your UI
  age_group: selectedAgeGroup,
  level: selectedLevel,
  buddyName: selectedBuddyName,
  topic: selectedTopic,
  mode: selectedMode
};

// Send this to the parent GPT (Talk Buddy)
window.parent.postMessage({ action: "startSession", selections }, "*");

    ];

    function startSession() {
      const startScreen = document.getElementById('startScreen');
      const setupScreen = document.getElementById('setupScreen');
      startScreen.classList.add('hidden');
      setupScreen.classList.remove('hidden');
      setTimeout(() => setupScreen.classList.add('active'), 50);
      console.log('Session started setup');
    }

    document.querySelectorAll('.category').forEach(category => {
      const buttons = category.querySelectorAll('button');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          buttons.forEach(btn => btn.classList.remove('selected'));
          button.classList.add('selected');
          selections[category.dataset.category] = button.textContent;
          checkCompletion();
        });
      });
    });

    function checkCompletion() {
      const allSelected = requiredCategories.every(c => selections[c]);
      const letsTalk = document.getElementById('letsTalk');
      if (allSelected) {
        letsTalk.classList.add('active');
      } else {
        letsTalk.classList.remove('active');
      }
    }
async function beginChat() {
  const letsTalk = document.getElementById('letsTalk');
  if (!letsTalk.classList.contains('active')) return;

  document.getElementById('setupScreen').classList.add('hidden');
  const sessionControls = document.getElementById('sessionControls');
  sessionControls.classList.remove('hidden');
  sessionControls.querySelectorAll('button').forEach(btn => btn.classList.add('active'));

  console.log('Chat begins with settings:', selections);

  // ðŸ§© Connect to GPT logic
  try {
    const response = await fetch(PROXY_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    messages: [
      { role: "system", content: "You are Talk Buddy, the English tutor." },
      { role: "user", content: `Start session with ${JSON.stringify(selections)}` }
    ]
  })
});


    const data = await response.json();
    const firstMessage = data.choices?.[0]?.message?.content || "Hello! Let's begin!";
    alert(firstMessage); // Replace with voice output later
  } catch (error) {
    console.error("Error starting chat:", error);
  }
}
      // TODO: connect to GPT chat logic here
    }

async function changeTopic() {
  console.log('Change topic clicked');
  try {
    const response = await fetchfetch(PROXY_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    messages: [
      { role: "system", content: "You are Talk Buddy, the English tutor." },
      { role: "user", content: `Start session with ${JSON.stringify(selections)}` }
    ]
  })
});

    const data = await response.json();
    alert(data.choices[0].message.content);
  } catch (error) {
    console.error(error);
  }
}
      // TODO: connect to GPT topic change
    }

async function changeMode() {
  console.log('Change mode clicked');
  try {
    const response = await fetchfetch(PROXY_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    messages: [
      { role: "system", content: "You are Talk Buddy, the English tutor." },
      { role: "user", content: `Start session with ${JSON.stringify(selections)}` }
    ]
  })
});

    const data = await response.json();
    alert(data.choices[0].message.content);
  } catch (error) {
    console.error(error);
  }
}
      // TODO: connect to GPT mode change
    }

async function endSession() {
  console.log('Session ended');
  try {
    const response = await fetchfetch(PROXY_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    messages: [
      { role: "system", content: "You are Talk Buddy, the English tutor." },
      { role: "user", content: `Start session with ${JSON.stringify(selections)}` }
    ]
  })
});

    const data = await response.json();
    alert(data.choices[0].message.content);
    location.reload(); // restart interface
  } catch (error) {
    console.error(error);
  }
}
      // TODO: connect to GPT end session logic
      alert('Session ended. Great work!');
      location.reload();
    }
  </script>
</body>
</html>


